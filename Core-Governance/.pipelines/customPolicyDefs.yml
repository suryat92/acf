# Trigger for each pipeline is defined in the Devops portal
# so that the YAML remains agnostic
trigger: none

name: Core-Governance Deploy

variables:
  - group: Shared
  - name: workingDirectory
    value: $(System.DefaultWorkingDirectory)/policy/definitions
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: componentname
    value: custom-policy-definitions

pool:
  vmImage: ubuntu-latest

stages:
  - stage: CoreGovernanceWhatifAndDeploy

    jobs:
      - job: ValidateandWhatif

        steps:
          - task: AzureCLI@2
            displayName: Lint
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              workingDirectory: $(WorkingDirectory)
              inlineScript: |
                az --version
                az bicep install
                bicep build $(componentname).bicep

          - task: AzurePowerShell@5
            displayName: What-If
            inputs:
              azureSubscription: $(azureServiceConnection)
              azurePowerShellVersion: LatestVersion
              pwsh: true
              workingDirectory: $(WorkingDirectory)
              ScriptType: "FilePath"
              ScriptPath: "./.azure-pipelines/CoreGovernanceManagementDeploy.ps1"
              scriptArguments:
                -whatif

      - job: Deploy
        dependsOn: ValidateandWhatif
        condition: and(succeeded(), eq(variables.isMain, 'true'))

        steps:
          - task: AzurePowerShell@5
            displayName: Deployment
            inputs:
              azureSubscription: $(azureServiceConnection)
              azurePowerShellVersion: LatestVersion
              pwsh: true
              workingDirectory: $(WorkingDirectory)
              ScriptType: "FilePath"
              ScriptPath: "./.azure-pipelines/CoreGovernanceManagementDeploy.ps1"
